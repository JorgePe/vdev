#!/bin/sh -e

PREREQS=""

prereqs() { echo "$PREREQS"; }

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

. /usr/share/initramfs-tools/hook-functions

# helper programs
mkdir -p $DESTDIR/lib/vdev
for prog in /lib/vdev/*; do

   # shell script or library?
   if [ -z "${prog#*.sh}" ]; then 

      cp -a $prog $DESTDIR/lib/vdev/
   else

      # binary?
      if [ -f $prog -a -x $prog ]; then 

         copy_exec $prog /lib/vdev
      fi
   fi
done

# config 
mkdir -p $DESTDIR/etc/vdev
cp -a /etc/vdev/* $DESTDIR/etc/vdev/

# the daemon itself 
copy_exec /sbin/vdevd

# blkid (needed by vdevd's helpers)
if [ -f /sbin/blkid ]; then 
   copy_exec /sbin/blkid
fi

# lvm tools (needed by vdevd's helpers)
if [ -f /sbin/lvs ]; then
   copy_exec /sbin/lvs
fi

if [ -f /sbin/pvs ]; then 
   copy_exec /sbin/pvs
fi

if [ -f /sbin/lvm ]; then 
   copy_exec /sbin/lvm
fi

# network tools (needed by vdevd's helpers)
if [ -f /bin/ip ]; then
   copy_exec /bin/ip
fi

if [ -f /sbin/ip ]; then 
   copy_exec /sbin/ip
fi

# SELinux tools
if [ -f /sbin/restorecon ]; then 
   copy_exec /sbin/restorecon || true
fi

# device tools
if [ -f /sbin/MAKEDEV ]; then 
   copy_exec /sbin/MAKEDEV || true
fi

# device mapper tools
if [ -f /sbin/dmsetup ]; then 
   copy_exec /sbin/dmsetup 
fi

# GNU tools (not the busybox equivalents)
copy_exec /bin/sed
copy_exec /bin/grep 
copy_exec /bin/fgrep
copy_exec /bin/egrep 
copy_exec /bin/chown /bin/vdev-chown 
copy_exec /bin/chmod /bin/vdev-chmod

# Linux tools
copy_exec /bin/kmod 

# users and groups databases
cp -a /etc/passwd $DESTDIR/etc/passwd
cp -a /etc/group $DESTDIR/etc/group

# since vdevd is multi-threaded, libpthread will dynamically load libgcc_s
# (and copy_exec won't detect this)
copy_exec /lib/`gcc -print-multiarch`/libgcc_s.so.1
